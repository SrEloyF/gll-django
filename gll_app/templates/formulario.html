{% extends "base.html" %}
{% block title %}
  {% if form.instance.pk %}
  Editar
  {% else %}
  Crear
  {% endif %}
   Gallo
{% endblock %}

{% block content %}
<div class="container py-2 py-md-4">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white d-flex flex-column flex-md-row justify-content-between align-items-center">
      <h2 class="mb-2 mb-md-0 d-flex align-items-center fs-4 fs-md-3">
        <i class="bi bi-calendar-event me-2"></i>
        {% if form.instance.pk %}Editar{% else %}Registrar{% endif %} Gallo
      </h2>

      {% if form.instance.pk %}
        <a class="btn btn-warning mt-2 mt-md-0" href="{% url 'ver' idGallo=form.instance.pk %}">
          Ver gallo
        </a>
      {% endif %}
    </div>

    <div class="card-body">
      <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate id="mainForm">
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {{ form.non_field_errors }}
        </div>
        {% endif %}

        <div class="row g-3">
          <!-- Datos básicos -->
          <div class="col-12 col-md-6">
            <div class="form-floating mb-3 position-relative">
              {{ form.nroPlaca }}
              <label for="{{ form.nroPlaca.id_for_label }}">Número de Placa</label>
              <div id="placa-error" class="invalid-feedback" style="display: none;"></div>
              {% if form.nroPlaca.errors %}
              <script>
                document.addEventListener('DOMContentLoaded', () => {
                  const errDiv = document.getElementById('placa-error');
                  errDiv.textContent = '{{ form.nroPlaca.errors.as_text|escapejs }}';
                  errDiv.style.display = 'block';
                  document.getElementById('id_nroPlaca').classList.add('is-invalid');
                });
              </script>
              {% endif %}
              <div class="position-absolute end-0 top-0 d-flex mt-2 me-2">
                <button type="button" class="btn btn-success ms-2" onclick="abrirModalBuscarSelect('id_nroPlaca', 'Buscar Placa', 'Número de Placa')">
                  <i class="bi bi-search text-white"></i>
                </button>
                <button class="btn btn-success ms-2" id="btnAniadirPlaca" type="button">
                  <i class="bi bi-plus text-white"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="form-floating mb-3">
              {{ form.fechaNac }}
              <label for="{{ form.fechaNac.id_for_label }}">Fecha de Nacimiento</label>
              {% if form.fechaNac.errors %}
              <div class="invalid-feedback d-block">{{ form.fechaNac.errors }}</div>
              {% endif %}
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div class="form-floating mb-3">
              {{ form.color }}
              <label for="{{ form.color.id_for_label }}">Color <span class="text-danger">*</span></label>
              {% if form.color.errors %}
                <div class="invalid-feedback d-block">{{ form.color.errors }}</div>
              {% endif %}
              
              <div class="position-absolute end-0 top-0 d-flex mt-2 me-2">
                <div class="input-group-text">
                  <i class="bi bi-palette text-primary"></i>
                </div>
                <button type="button" class="btn btn-success ms-2" onclick="abrirModalBuscarSelect('id_color', 'Buscar Color', 'Color')">
                  <i class="bi bi-search text-white"></i>
                </button>
                <button class="btn btn-success ms-2" id="btnAniadirColor" type="button">
                  <i class="bi bi-plus text-white"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div class="form-floating mb-3">
              {{ form.sexo }}
              <label for="{{ form.sexo.id_for_label }}">Sexo <span class="text-danger">*</span></label>
              {% if form.sexo.errors %}
              <div class="invalid-feedback d-block">{{ form.sexo.errors }}</div>
              {% endif %}
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div class="form-floating mb-3">
              {{ form.tipoGallo }}
              <label for="{{ form.tipoGallo.id_for_label }}">Tipo de Gallo <span class="text-danger">*</span></label>
              {% if form.tipoGallo.errors %}
              <div class="invalid-feedback d-block">{{ form.tipoGallo.errors }}</div>
              {% endif %}
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="form-floating mb-3 position-relative">
              {{ form.peso }}
              <label for="{{ form.peso.id_for_label }}">Peso (libras) <span class="text-danger">*</span></label>
              {% if form.peso.errors %}
              <div class="invalid-feedback d-block">{{ form.peso.errors }}</div>
              {% endif %}
              <div class="position-absolute end-0 top-0 d-flex mt-2 me-2">
                <button type="button" class="btn btn-success ms-2" onclick="abrirModalBuscarSelect('id_peso', 'Buscar Peso', 'Peso')">
                  <i class="bi bi-search text-white"></i>
                </button>
                <button class="btn btn-success ms-2" id="btnAniadirPeso" type="button">
                  <i class="bi bi-plus text-white"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="form-floating mb-3 position-relative">
              {{ form.nroPlacaAnterior }}
              <label for="{{ form.nroPlacaAnterior.id_for_label }}">Número de Placa Anterior</label>
              {% if form.nroPlacaAnterior.errors %}
              <div class="invalid-feedback d-block">{{ form.nroPlacaAnterior.errors }}</div>
              {% endif %}
              <div class="position-absolute end-0 top-0 d-flex mt-2 me-2">
                <button type="button" class="btn btn-success ms-2" onclick="abrirModalBuscarSelect('id_nroPlacaAnterior', 'Buscar Placa Anterior', 'Placa')">
                  <i class="bi bi-search text-white"></i>
                </button>
                <button class="btn btn-success ms-2" id="btnAniadirPlacaAnterior" type="button">
                  <i class="bi bi-plus text-white"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="form-floating mb-3">
              {{ form.nombreDuenoAnterior }}
              <label for="{{ form.nombreDuenoAnterior.id_for_label }}">Nombre del Dueño Anterior</label>
              {% if form.nombreDuenoAnterior.errors %}
                <div class="invalid-feedback d-block">{{ form.nombreDuenoAnterior.errors }}</div>
              {% endif %}

              <div class="position-absolute end-0 top-0 d-flex mt-2 me-2">
                <div class="input-group-text">
                  <i class="bi bi-person-fill text-primary"></i>
                </div>
                <button type="button" class="btn btn-success ms-2" onclick="abrirModalBuscarSelect('id_nombreDuenoAnterior', 'Buscar Dueño Anterior', 'Nombre')">
                  <i class="bi bi-search text-white"></i>
                </button>
                <button class="btn btn-success ms-2" id="btnAniadirDuenoAnterior" type="button">
                  <i class="bi bi-plus text-white"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="form-floating position-relative mb-3">
              {{ form.estadoDeSalud }}
              <label for="{{ form.estadoDeSalud.id_for_label }}">Estado de Salud <span class="text-danger">*</span></label>

              {% if form.estadoDeSalud.errors %}
                <div class="invalid-feedback d-block">{{ form.estadoDeSalud.errors }}</div>
              {% endif %}

              <div class="position-absolute end-0 top-0 d-flex mt-2 me-2">
                <div class="input-group-text">
                  <i class="bi bi-bandaid text-primary"></i>
                </div>
                <button type="button" class="btn btn-success ms-2" onclick="abrirModalBuscarSelect('id_estadoDeSalud', 'Buscar Estado de Salud', 'Estado')">
                  <i class="bi bi-search text-white"></i>
                </button>
                <button class="btn btn-success ms-2" id="btnAniadirEstado" type="button">
                  <i class="bi bi-plus text-white"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="form-floating mb-3">
              {{ form.fechaMuerte }}
              <label for="{{ form.fechaMuerte.id_for_label }}">Fecha de Muerte</label>
              {% if form.fechaMuerte.errors %}
              <div class="invalid-feedback d-block">{{ form.fechaMuerte.errors }}</div>
              {% endif %}
            </div>
          </div>
        
        </div>

        <div class="col-12 mb-3">
          <label for="{{ form.nombre_img.id_for_label }}" class="form-label">Imagen <span class="text-danger">*</span></label>
        
          <!-- Mostrar imagen existente si estamos editando -->
          {% if form.instance.nombre_img %}
          <div class="mb-3">
            <img src="{{ form.instance.nombre_img }}" class="img-fluid img-thumbnail" alt="Imagen actual del gallo"
              style="max-height: 200px;" loading="lazy">
            <p class="form-text mt-1">Imagen actual. Seleccione una nueva imagen para reemplazarla.</p>
          </div>
          {% endif %}
        
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-camera-fill"></i></span>
            {{ form.nombre_img }}
          </div>
          {% if form.nombre_img.errors %}
          <div class="invalid-feedback d-block">{{ form.nombre_img.errors }}</div>
          {% endif %}
          <div class="form-text">
            {% if form.instance.nombre_img %}
            Seleccione una nueva imagen para reemplazar la actual.
            {% else %}
            Seleccione una imagen del ave para su registro.
            {% endif %}
          </div>
        </div>

        <!-- Archivos Adicionales - Solo mostrar si estamos editando -->
        {% if form.instance.pk %}
          {% if archivos_imagenes or archivos_videos %}
          <div class="card mt-4 mb-4 border-warning">
            <div class="card-header bg-warning text-dark">
              <h5 class="card-title mb-0">
                <i class="bi bi-folder-fill me-2"></i>Archivos Adicionales Añadidos
              </h5>
            </div>
            <div class="card-body">
              {% if archivos_imagenes %}
              <div class="mb-3">
                <h6><i class="bi bi-image me-1"></i>Imágenes:</h6>
                <div class="row g-2">
                  {% for imagen in archivos_imagenes %}
                  <div class="col-6 col-md-4 col-lg-3" id="archivo-{{ imagen.id }}">
                    <div class="position-relative">
                      <img src="{{ imagen.archivo }}" class="img-fluid img-thumbnail" alt="Imagen adicional" loading="lazy">
                      <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                              onclick="eliminarArchivo({{ imagen.id }})">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                    <small class="text-muted d-block text-center">{{ imagen.fecha_creacion|date:"d/m/Y H:i" }}</small>
                  </div>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
              
              {% if archivos_videos %}
              <div class="mb-3">
                <h6><i class="bi bi-camera-video me-1"></i>Videos:</h6>
                <div class="row g-2">
                  {% for video in archivos_videos %}
                  <div class="col-12 col-md-4" id="archivo-{{ video.id }}">
                    <div class="position-relative">
                      <video controls class="w-100" style="max-height: 200px;" preload="none">
                        <source src="{{ video.archivo }}" type="video/mp4">
                        Tu navegador no soporta la reproducción de video.
                      </video>
                      <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                              onclick="eliminarArchivo({{ video.id }})">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                    <small class="text-muted d-block text-center">{{ video.fecha_creacion|date:"d/m/Y H:i" }}</small>
                  </div>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        {% endif %}

        <!-- Sección para añadir nuevos archivos -->
        <div class="card mt-4 mb-4 border-success">
          <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-plus-circle me-2"></i>Añadir Archivos Adicionales
            </h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Seleccionar archivos (imágenes o videos)</label>
              <div class="input-group">
                <!-- name important para compatibilidad con envío tradicional -->
                <input type="file"
                      id="archivos_adicionales_input"
                      name="archivos_adicionales[]"
                      class="form-control"
                      accept="image/*,video/*"
                      multiple
                      onchange="handleFilesSelected(this)">
                <button type="button" class="btn btn-outline-secondary" onclick="limpiarArchivos()">
                  <i class="bi bi-x-circle"></i> Limpiar
                </button>
              </div>
              <div class="form-text">
                Puedes seleccionar múltiples imágenes o videos.
              </div>
            </div>

            <!-- Preview de archivos a subir -->
            <div id="preview-archivos" class="d-none">
              <h6>Archivos a subir (<span id="contador-archivos">0</span>):</h6>
              <!-- Lista numerada y visual -->
              <div id="lista-archivos" class="row g-2"></div>
            </div>
          </div>
        </div>

        <!-- Genealogía - Responsive -->
        <div class="card mt-4 mb-4 border-primary-subtle">
          <div class="card-header bg-primary-subtle">
            <h5 class="card-title mb-0">Genealogía</h5>
            <div class="form-text">
              No puedes seleccionar al mismo gallo como padre o madre.
            </div>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <!-- Padre - Responsive -->
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold">Padre</label>
                <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center">
                  <button type="button" class="btn btn-primary mb-2 mb-md-0" data-bs-toggle="modal"
                    data-bs-target="#modalPadre">
                    <i class="bi bi-search me-1"></i> Seleccionar Padre
                  </button>
                  <input type="hidden" id="inputPadre" name="placaPadre" value="{{ padre_sel|default_if_none:'' }}">
                  <div class="d-flex align-items-center ms-md-2">
                    <span id="padreSeleccionado" class="badge bg-success {% if not padre_sel %}d-none{% endif %}">
                      {% if placa_padre %}
                        Placa: {{ placa_padre }}
                      {% else %}
                        Placa: —
                      {% endif %}
                    </span>
                    {% if padre_sel %}
                    <button type="button" class="btn btn-danger btn-sm ms-2" id="quitarPadre">
                      <i class="bi bi-x-circle me-1"></i> Quitar
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-danger btn-sm ms-2 d-none" id="quitarPadre">
                      <i class="bi bi-x-circle me-1"></i> Quitar
                    </button>
                    {% endif %}
                  </div>
                </div>
              </div>
              
              <!-- Madre - Responsive -->
              <div class="col-12 col-md-6">
                <label class="form-label fw-bold">Madre</label>
                <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center">
                  <button type="button" class="btn btn-primary mb-2 mb-md-0" data-bs-toggle="modal"
                    data-bs-target="#modalMadre">
                    <i class="bi bi-search me-1"></i> Seleccionar Madre
                  </button>
                  <input type="hidden" id="inputMadre" name="placaMadre" value="{{ madre_sel|default_if_none:'' }}">
                  <div class="d-flex align-items-center ms-md-2">

                    <span id="madreSeleccionada" class="badge bg-success {% if not madre_sel %}d-none{% endif %}">
                      {% if placa_madre %}
                        Placa: {{ placa_madre }}
                      {% else %}
                        Placa: —
                      {% endif %}
                    </span>

                    {% if madre_sel %}
                    <button type="button" class="btn btn-danger btn-sm ms-2" id="quitarMadre">
                      <i class="bi bi-x-circle me-1"></i> Quitar
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-danger btn-sm ms-2 d-none" id="quitarMadre">
                      <i class="bi bi-x-circle me-1"></i> Quitar
                    </button>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Botones de acción - Responsive -->
        <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-center gap-3 mt-4">
          <div class="d-flex flex-column flex-md-row gap-2 order-0 order-md-1 w-100 w-md-auto">
            <a href="{% url 'index' %}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-1"></i>Volver
            </a>
            <button type="submit" class="btn btn-success" id="submit-btn">
              <i class="bi bi-save me-1"></i>Guardar
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Padre -->
<div class="modal fade" id="modalPadre" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-gender-male me-2"></i>Seleccionar Padre</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="padres-modal-loader" class="text-center py-4 d-none">
          <div class="spinner-border text-primary" role="status"></div>
          <div class="mt-2">Cargando resultados...</div>
        </div>
        <div id="padres-modal-content">
          <!-- Aquí se cargará dinámicamente el contenido AJAX -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Madre -->
<div class="modal fade" id="modalMadre" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-gender-female me-2"></i>Seleccionar Madre</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="madres-modal-loader" class="text-center py-4 d-none">
          <div class="spinner-border text-primary" role="status"></div>
          <div class="mt-2">Cargando resultados...</div>
        </div>
        <div id="madres-modal-content">
          <!-- Aquí se cargará dinámicamente el contenido AJAX -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- modal para los selects -->
<div class="modal fade" id="modalBuscarSelect" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalBuscarSelectTitle"></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control mb-3" id="buscarSelectInput" placeholder="Buscar...">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th id="modalBuscarSelectCol"></th>
                <th class="text-end">Acción</th>
              </tr>
            </thead>
            <tbody id="modalBuscarSelectBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<div id="upload-overlay" style="display:none;">
  <div id="upload-overlay-backdrop"></div>
  <div id="upload-overlay-card" role="status" aria-live="polite">
    <div id="upload-overlay-spinner" aria-hidden="true"></div>
    <div id="upload-overlay-text">
      <strong>Guardando datos, no cierre esta pestaña</strong>
      <div id="upload-overlay-subtext">Subiendo archivos... por favor espere</div>
      <progress id="progress-bar" max="100" value="0"></progress>
      <p id="progress-text">0%</p>
    </div>
  </div>
</div>

<style>
  #upload-overlay { position: fixed; inset: 0; z-index: 2000; font-family: inherit; }
  #upload-overlay-backdrop { position:absolute; inset:0; background: rgba(0,0,0,0.55); }
  #upload-overlay-card {
    position: absolute;
    left: 50%; top: 45%;
    transform: translate(-50%, -50%);
    background: #fff; color: #000; padding: 20px; border-radius: 8px;
    width: 320px; max-width: 90%; display:flex; gap:12px; align-items:center;
    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
  }
  #upload-overlay-spinner {
    width:48px; height:48px; border-radius:50%;
    border:5px solid rgba(0,0,0,0.12); border-top-color: #0d6efd;
    animation: spin 1s linear infinite;
    flex: 0 0 48px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #upload-overlay-text { flex:1; font-size:0.95rem; }
  #upload-overlay-subtext { font-size:0.85rem; color:#555; margin-top:6px; }
</style>

<script>

  function addUpperCaseListenerToSwalInputs() {
    const observer = new MutationObserver((mutationsList) => {
      mutationsList.forEach((mutation) => {
        if (mutation.type === 'childList') {
          const swalInputs = document.querySelectorAll('.swal2-input');
          swalInputs.forEach(input => {
            if (!input.hasAttribute('data-upper-case-listener')) {
              input.addEventListener('input', () => {
                input.value = input.value.toUpperCase();
              });
              input.setAttribute('data-upper-case-listener', 'true');
            }
          });
        }
      });
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  }

  document.getElementById('{{ form.nombre_img.id_for_label }}').classList.add('form-control');

  // Inicialización de validación de Bootstrap
  (() => {
    'use strict';
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  })();

  document.addEventListener('DOMContentLoaded', function () {
    addUpperCaseListenerToSwalInputs();

    const inputPlaca = document.getElementById('id_nroPlaca');
    const errDiv = document.getElementById('placa-error');
    const submitBtn = document.getElementById('submit-btn');

    inputPlaca.addEventListener('blur', function () {
      const placa = this.value.trim();
      if (!placa) {
        this.classList.remove('is-invalid');
        errDiv.textContent = '';
        errDiv.style.display = 'none';
        submitBtn.disabled = false;
        return;
      }

      fetch('{% url "ajax_valida_placa" %}?placa=' + encodeURIComponent(placa))
        .then(res => res.json())
        .then(data => {
          if (data.exists) {
            this.classList.add('is-invalid');
            errDiv.textContent = 'La placa ya está registrada.';
            errDiv.style.display = 'block';
            submitBtn.disabled = true;
          } else {
            this.classList.remove('is-invalid');
            errDiv.textContent = '';
            errDiv.style.display = 'none';
            submitBtn.disabled = false;
          }
        })
        .catch(err => {
          console.error('Error en la validación AJAX:', err);
          submitBtn.disabled = true;
        });
    });


    function añadirEstado(selectId) {
      Swal.fire({
        title: 'Ingresa nuevo estado:',
        input: 'text',
        inputPlaceholder: 'Introduce el nombre aquí',
        showCancelButton: true,
        confirmButtonText: 'Registrar',
        cancelButtonText: 'Cancelar',
        preConfirm: (inputValue) => {
          if (!inputValue) {
            Swal.showValidationMessage('¡Por favor, ingresa algo!');
          }
          return inputValue;
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const nombre = result.value;

          fetch("{% url 'estado_create_ajax' %}", {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
            },
            body: new URLSearchParams({
              'nombre': nombre,
            })
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                const selectEstado = document.getElementById(selectId);
                const nuevaOpcionEstado = document.createElement('option');
                nuevaOpcionEstado.value = data.id;
                nuevaOpcionEstado.textContent = data.nombre;
                selectEstado.appendChild(nuevaOpcionEstado);
                nuevaOpcionEstado.selected = true;
                Swal.fire('¡Éxito!', 'Estado registrado correctamente.', 'success');
              } else {
                Swal.fire('Error', data.error || 'No se pudo registrar.', 'error');
              }
            })
            .catch(error => {
              console.error(error);
              Swal.fire('Error', 'Error en la petición.', 'error');
            });
        }
      });
    }

    function añadirColor(selectId) {
      Swal.fire({
        title: 'Ingresa nuevo color:',
        input: 'text',
        inputPlaceholder: 'Introduce el nombre aquí',
        showCancelButton: true,
        confirmButtonText: 'Registrar',
        cancelButtonText: 'Cancelar',
        preConfirm: (inputValue) => {
          if (!inputValue) {
            Swal.showValidationMessage('¡Por favor, ingresa algo!');
          }
          return inputValue;
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const nombre = result.value;

          fetch("{% url 'color_create_ajax' %}", {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
            },
            body: new URLSearchParams({
              'nombre': nombre,
            })
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                const selectColor = document.getElementById(selectId);
                const nuevaOpcionColor = document.createElement('option');
                nuevaOpcionColor.value = data.id;
                nuevaOpcionColor.textContent = data.nombre;
                selectColor.appendChild(nuevaOpcionColor);
                nuevaOpcionColor.selected = true;

                Swal.fire('¡Éxito!', 'Color registrado correctamente.', 'success');
              } else {
                Swal.fire('Error', data.error || 'No se pudo registrar.', 'error');
              }
            })
            .catch(error => {
              console.error(error);
              Swal.fire('Error', 'Error en la petición.', 'error');
            });
        }
      });
    }

    function añadirDuenoAnterior(selectId) {
      Swal.fire({
        title: 'Ingresa nombre del dueño anterior:',
        input: 'text',
        inputPlaceholder: 'Introduce el nombre aquí',
        showCancelButton: true,
        confirmButtonText: 'Registrar',
        cancelButtonText: 'Cancelar',
        preConfirm: (inputValue) => {
          if (!inputValue) {
            Swal.showValidationMessage('¡Por favor, ingresa algo!');
          }
          return inputValue;
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const nombre = result.value;

          fetch("{% url 'duenoanterior_create_ajax' %}", {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
            },
            body: new URLSearchParams({
              'nombre': nombre,
            })
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                const selectDuenoAnterior = document.getElementById(selectId);

                const nuevaOpcionDuenoAnterior = document.createElement('option');
                nuevaOpcionDuenoAnterior.value = data.id;
                nuevaOpcionDuenoAnterior.textContent = data.nombre;

                selectDuenoAnterior.appendChild(nuevaOpcionDuenoAnterior);
                nuevaOpcionDuenoAnterior.selected = true;

                Swal.fire('¡Éxito!', 'Dueño anterior registrado correctamente.', 'success');
              } else {
                Swal.fire('Error', data.error || 'No se pudo registrar.', 'error');
              }
            })
            .catch(error => {
              console.error(error);
              Swal.fire('Error', 'Error en la petición.', 'error');
            });
        }
      });
    }

    function añadirPlaca(selectId) {
      Swal.fire({
        title: 'Ingresa nueva placa:',
        input: 'number',
        inputPlaceholder: 'Introduce el número aquí',
        inputAttributes: {
          min: 1,
          step: 1
        },
        showCancelButton: true,
        confirmButtonText: 'Registrar',
        cancelButtonText: 'Cancelar',
        preConfirm: (inputValue) => {
          const value = Number(inputValue);
          if (!inputValue) {
            Swal.showValidationMessage('¡Por favor, ingresa un número!');
          } else if (!Number.isInteger(value) || value <= 0) {
            Swal.showValidationMessage('Debes ingresar un número entero positivo.');
          }
          return value;
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const nroPlaca = result.value;
          fetch("{% url 'placa_create_ajax' %}", {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
            },
            body: new URLSearchParams({
              'nroPlaca': nroPlaca,
            })
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // Añadir la opción ordenada en ambos selects
                ['id_nroPlaca', 'id_nroPlacaAnterior'].forEach(function(selectName) {
                  const select = document.getElementById(selectName);
                  if (select) {
                    const options = Array.from(select.options);
                    const nuevaOpcion = document.createElement('option');
                    nuevaOpcion.value = data.id;
                    nuevaOpcion.textContent = data.nroPlaca;
                    
                    // Encontrar la posición correcta para insertar (orden ascendente)
                    let insertIndex = options.length;
                    for (let i = 0; i < options.length; i++) {
                      const optionValue = parseInt(options[i].textContent);
                      if (nroPlaca < optionValue) {
                        insertIndex = i;
                        break;
                      }
                    }
                    
                    // Insertar en la posición correcta
                    if (insertIndex === options.length) {
                      select.appendChild(nuevaOpcion);
                    } else {
                      select.insertBefore(nuevaOpcion, select.options[insertIndex]);
                    }
                    
                    // Seleccionar solo en el select que disparó el evento
                    if (selectName === selectId) {
                      nuevaOpcion.selected = true;
                    }
                  }
                });
                Swal.fire('¡Éxito!', 'Placa registrada correctamente.', 'success');
              } else {
                Swal.fire('Error', data.error || 'No se pudo registrar.', 'error');
              }
            })
            .catch(error => {
              console.error(error);
              Swal.fire('Error', 'Error en la petición.', 'error');
            });
        }
      });
    }

    function añadirPeso(selectId) {
      Swal.fire({
        title: 'Ingresa nuevo peso:',
        input: 'text',
        inputPlaceholder: 'Introduce el peso aquí',
        inputAttributes: {
          pattern: '^\\d*\\.?\\d+$',
          title: 'Por favor, ingresa un número válido'
        },
        showCancelButton: true,
        confirmButtonText: 'Registrar',
        cancelButtonText: 'Cancelar',
        preConfirm: (inputValue) => {
          const regex = /^(\d+(\.\d{1,2})?)?$/;
          if (!inputValue) {
            Swal.showValidationMessage('¡Por favor, ingresa un peso!');
          } else if (!regex.test(inputValue)) {
            Swal.showValidationMessage('El peso debe ser un número válido con hasta dos decimales.');
          } else {
            const value = Number(inputValue);
            if (value <= 0) {
              Swal.showValidationMessage('Debes ingresar un peso positivo.');
            }
            return value;
          }
        }
      })
        .then((result) => {
          if (result.isConfirmed) {
            const peso = result.value;
            fetch("{% url 'peso_create_ajax' %}", {
              method: 'POST',
              headers: {
                'X-CSRFToken': '{{ csrf_token }}',
              },
              body: new URLSearchParams({
                'peso': peso,
              })
            })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  const selectPeso = document.getElementById(selectId);
                  const options = Array.from(selectPeso.options);
                  const nuevaOpcionPeso = document.createElement('option');
                  nuevaOpcionPeso.value = data.id;
                  nuevaOpcionPeso.textContent = data.peso;

                  // Encontrar la posición correcta para insertar
                  let insertIndex = options.length;
                  for (let i = 0; i < options.length; i++) {
                    const optionValue = parseFloat(options[i].textContent);
                    if (peso < optionValue) {
                      insertIndex = i;
                      break;
                    }
                  }
                  
                  // Insertar la nueva opción en la posición correcta
                  if (insertIndex === options.length) {
                    selectPeso.appendChild(nuevaOpcionPeso);
                  } else {
                    selectPeso.insertBefore(nuevaOpcionPeso, selectPeso.options[insertIndex]);
                  }
                  
                  nuevaOpcionPeso.selected = true;
                  Swal.fire('¡Éxito!', 'Peso registrado correctamente.', 'success');
                } else {
                  Swal.fire('Error', data.error || 'No se pudo registrar.', 'error');
                }
              })
              .catch(error => {
                console.error(error);
                Swal.fire('Error', 'Error en la petición.', 'error');
              });
          }
        });
    }

    document.getElementById('btnAniadirPeso').addEventListener('click', function () {
      añadirPeso('id_peso');
    });

    document.getElementById('btnAniadirPlaca').addEventListener('click', function () {
      añadirPlaca('id_nroPlaca');
    });
    document.getElementById('btnAniadirPlacaAnterior').addEventListener('click', function () {
      añadirPlaca('id_nroPlacaAnterior');
    });

    document.getElementById('btnAniadirDuenoAnterior').addEventListener('click', function () {
      añadirDuenoAnterior('id_nombreDuenoAnterior');
    });

    document.getElementById('btnAniadirColor').addEventListener('click', function () {
      añadirColor('id_color');
    });

    document.getElementById('btnAniadirEstado').addEventListener('click', function () {
      añadirEstado('id_estadoDeSalud');
    });

  });
/*
  // Búsqueda en el modal de Padre
  document.getElementById('buscarPlacaPadre').addEventListener('input', function (e) {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('#modalPadre table tbody tr').forEach(row => {
      const placa = row.querySelector('td:first-child').textContent.toLowerCase();
      row.style.display = placa.includes(searchTerm) ? '' : 'none';
    });
  });

  // Búsqueda en el modal de Madre
  document.getElementById('buscarPlacaMadre').addEventListener('input', function (e) {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('#modalMadre table tbody tr').forEach(row => {
      const placa = row.querySelector('td:first-child').textContent.toLowerCase();
      row.style.display = placa.includes(searchTerm) ? '' : 'none';
    });
  });

  // Opcional: limpiar búsqueda al abrir cada modal
  document.getElementById('modalPadre').addEventListener('show.bs.modal', function () {
    document.getElementById('buscarPlacaMadre').value = '';
    document.querySelectorAll('#modalPadre table tbody tr').forEach(row => row.style.display = '');
  });
  document.getElementById('modalMadre').addEventListener('show.bs.modal', function () {
    document.getElementById('buscarPlacaMadre').value = '';
    document.querySelectorAll('#modalMadre table tbody tr').forEach(row => row.style.display = '');
  });*/

  function abrirModalBuscarSelect(selectId, titulo, columna) {
    const filas = 8;
    const select = document.getElementById(selectId);
    const modal = new bootstrap.Modal(document.getElementById('modalBuscarSelect'));
    const modalTitle = document.getElementById('modalBuscarSelectTitle');
    const modalCol = document.getElementById('modalBuscarSelectCol');
    const modalBody = document.getElementById('modalBuscarSelectBody');
    const buscarInput = document.getElementById('buscarSelectInput');

    modalTitle.textContent = titulo;
    modalCol.textContent = columna;
    buscarInput.value = '';

    // Extraer todas las opciones válidas
    const opciones = Array.from(select.options)
      .filter(option => option.value)
      .map(option => ({ value: option.value, text: option.text }));

    let paginaActual = 1;
    let opcionesFiltradas = [...opciones];

    function renderTabla() {
      modalBody.innerHTML = '';
      const inicio = (paginaActual - 1) * filas;
      const fin = inicio + filas;
      const pagina = opcionesFiltradas.slice(inicio, fin);

      pagina.forEach(opcion => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${opcion.text}</td>
          <td class="text-end">
            <button type="button" class="btn btn-success btn-sm seleccionar-opcion-modal" data-value="${opcion.value}" data-bs-dismiss="modal">
              <i class="bi bi-check-circle"></i> Seleccionar
            </button>
          </td>
        `;
        modalBody.appendChild(tr);
      });

      // Controles de paginación
      const totalPaginas = Math.ceil(opcionesFiltradas.length / filas);
      const paginacion = document.createElement('tr');
      paginacion.innerHTML = `
        <td colspan="2" class="text-center">
          <nav>
            <ul class="pagination justify-content-center mb-0">
              <li class="page-item ${paginaActual === 1 ? 'disabled' : ''}">
                <button class="page-link" id="anteriorPagina" ${paginaActual === 1 ? 'disabled' : ''}>&laquo; Anterior</button>
              </li>
              <li class="page-item disabled">
                <span class="page-link">Página ${paginaActual} de ${totalPaginas || 1}</span>
              </li>
              <li class="page-item ${paginaActual === totalPaginas || totalPaginas === 0 ? 'disabled' : ''}">
                <button class="page-link" id="siguientePagina" ${(paginaActual === totalPaginas || totalPaginas === 0) ? 'disabled' : ''}>Siguiente &raquo;</button>
              </li>
            </ul>
          </nav>
        </td>
      `;
      modalBody.appendChild(paginacion);

      // Eventos de paginación
      document.getElementById('anteriorPagina')?.addEventListener('click', function () {
        if (paginaActual > 1) {
          paginaActual--;
          renderTabla();
        }
      });
      document.getElementById('siguientePagina')?.addEventListener('click', function () {
        if (paginaActual < totalPaginas) {
          paginaActual++;
          renderTabla();
        }
      });
    }

    // Búsqueda global
    buscarInput.oninput = function () {
      const searchTerm = buscarInput.value.toLowerCase();
      opcionesFiltradas = opciones.filter(opcion => opcion.text.toLowerCase().includes(searchTerm));
      paginaActual = 1;
      renderTabla();
    };

    // Selección
    modalBody.onclick = function (e) {
      if (e.target.closest('.seleccionar-opcion-modal')) {
        const value = e.target.closest('.seleccionar-opcion-modal').dataset.value;
        select.value = value;
        select.dispatchEvent(new Event('change'));
      }
    };

    renderTabla();
    modal.show();
  }

  // Quitar Padre
  document.getElementById('quitarPadre')?.addEventListener('click', () => {
    document.getElementById('inputPadre').value = '';
    const badge = document.getElementById('padreSeleccionado');
    const botonEliminarPadre = document.getElementById('quitarPadre');
    botonEliminarPadre.classList.add('d-none');
    badge.classList.add('d-none');
  });

  // Quitar Madre
  document.getElementById('quitarMadre')?.addEventListener('click', () => {
    document.getElementById('inputMadre').value = '';
    const badge = document.getElementById('madreSeleccionada');
    const botonEliminarMadre = document.getElementById('quitarMadre');
    botonEliminarMadre.classList.add('d-none');
    badge.classList.add('d-none');
  });

  // Selección de padre
  function attachPadreSelectListeners() {
    document.querySelectorAll('.seleccionar-padre').forEach(btn => {
      btn.onclick = () => {
        const placa = btn.dataset.placa || '—';
        const idGallo = btn.dataset.idgallo;
        document.getElementById('inputPadre').value = idGallo;
        const badge = document.getElementById('padreSeleccionado');
        badge.textContent = `Placa: ${placa}`;
        badge.classList.remove('d-none');
        const botonEliminarPadre = document.getElementById('quitarPadre');
        botonEliminarPadre.classList.remove('d-none');
      };
    });
  }

  // Selección de madre
  function attachMadreSelectListeners() {
    document.querySelectorAll('.seleccionar-madre').forEach(btn => {
      btn.onclick = () => {
        const placa = btn.dataset.placa || '—';
        const idGallo = btn.dataset.idgallo;
        document.getElementById('inputMadre').value = idGallo;
        const badge = document.getElementById('madreSeleccionada');
        badge.textContent = `Placa: ${placa}`;
        badge.classList.remove('d-none');
        const botonEliminarMadre = document.getElementById('quitarMadre');
        botonEliminarMadre.classList.remove('d-none');
      };
    });
  }






  let archivosParaSubir = [];
  const form = document.querySelector('#mainForm');

  function previewArchivos(input) {
    const files = Array.from(input.files);
    archivosParaSubir = files;
    
    const previewContainer = document.getElementById('preview-archivos');
    const listaArchivos = document.getElementById('lista-archivos');
    
    if (files.length === 0) {
      previewContainer.classList.add('d-none');
      return;
    }
    
    previewContainer.classList.remove('d-none');
    listaArchivos.innerHTML = '';
    
    files.forEach((file, index) => {
      const col = document.createElement('div');
      col.className = 'col-6 col-md-4 col-lg-3';
      
      const card = document.createElement('div');
      card.className = 'card';
      
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          card.innerHTML = `
            <img src="${e.target.result}" class="card-img-top img-fluid" alt="${file.name}">
            <div class="card-body p-1">
              <small class="text-truncate d-block">${file.name}</small>
              <button type="button" class="btn btn-sm btn-danger w-100 mt-1" onclick="quitarArchivo(${index})">
                <i class="bi bi-trash"></i> Quitar
              </button>
            </div>
          `;
        };
        reader.readAsDataURL(file);
      } else if (file.type.startsWith('video/')) {
        card.innerHTML = `
          <div class="card-body text-center">
            <i class="bi bi-camera-video fs-1"></i>
            <small class="text-truncate d-block">${file.name}</small>
            <button type="button" class="btn btn-sm btn-danger w-100 mt-1" onclick="quitarArchivo(${index})">
              <i class="bi bi-trash"></i> Quitar
            </button>
          </div>
        `;
      }
      
      col.appendChild(card);
      listaArchivos.appendChild(col);
    });
  }

  function quitarArchivo(index) {
    archivosParaSubir.splice(index, 1);
    
    const dt = new DataTransfer();
    archivosParaSubir.forEach(file => dt.items.add(file));
    
    const input = document.getElementById('archivos_adicionales_input');
    input.files = dt.files;
    
    previewArchivos(input);
  }

  function limpiarArchivos() {
    archivosParaSubir = [];
    document.getElementById('archivos_adicionales_input').value = '';
    document.getElementById('preview-archivos').classList.add('d-none');
  }

  {% if form.instance.pk %}
  function eliminarArchivo(archivoId) {
    Swal.fire({
      title: '¿Estás seguro?',
      text: 'Esta acción no se puede deshacer',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`{% url 'delete_archivo_adicional' archivo_id=0 %}`.replace('0', archivoId), {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById(`archivo-${archivoId}`).remove();
            Swal.fire('¡Eliminado!', 'El archivo ha sido eliminado.', 'success');
            
            // Verificar si quedan archivos, si no hay, ocultar la sección
            const contenedor = document.querySelector('.card.border-warning');
            if (contenedor) {
              const imagenesRestantes = contenedor.querySelectorAll('[id^="archivo-"]').length;
              if (imagenesRestantes === 0) {
                contenedor.remove();
              }
            }
          } else {
            Swal.fire('Error', data.error || 'No se pudo eliminar el archivo', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          Swal.fire('Error', 'Error al eliminar el archivo', 'error');
        });
      }
    });
  }
  {% endif %}

  function handleFilesSelected(input) {
    const nuevos = Array.from(input.files || []);
    nuevos.forEach(f => {
      const existe = archivosParaSubir.some(a =>
        a.name === f.name && a.size === f.size && a.lastModified === f.lastModified
      );
      if (!existe) archivosParaSubir.push(f);
    });
    input.value = '';
    renderPreview();
    syncInputFilesWithArray();
  }

  function syncInputFilesWithArray() {
    const input = document.getElementById('archivos_adicionales_input');
    if (!window.DataTransfer) {
      return;
    }
    const dt = new DataTransfer();
    archivosParaSubir.forEach(file => dt.items.add(file));
    input.files = dt.files;
  }

  function renderPreview() {
    const previewContainer = document.getElementById('preview-archivos');
    const listaArchivos = document.getElementById('lista-archivos');
    const contador = document.getElementById('contador-archivos');

    listaArchivos.innerHTML = '';

    if (archivosParaSubir.length === 0) {
      previewContainer.classList.add('d-none');
      contador.textContent = '0';
      return;
    }

    previewContainer.classList.remove('d-none');
    contador.textContent = archivosParaSubir.length;

    archivosParaSubir.forEach((file, index) => {
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6 col-lg-4';
      const card = document.createElement('div');
      card.className = 'card';
      const header = document.createElement('div');
      header.className = 'card-header d-flex justify-content-between align-items-center p-2';
      const title = document.createElement('small');
      title.className = 'fw-bold text-truncate';
      title.style.maxWidth = '70%';
      const tipoLabel = file.type.startsWith('image/') ? 'Imagen' : (file.type.startsWith('video/') ? 'Video' : 'Archivo');
      title.textContent = `${tipoLabel}${index + 1} — ${file.name}`;

      const btnQuitar = document.createElement('button');
      btnQuitar.type = 'button';
      btnQuitar.className = 'btn btn-sm btn-outline-danger';
      btnQuitar.innerHTML = '<i class="bi bi-trash"></i> Quitar';
      btnQuitar.onclick = () => quitarArchivo(index);

      header.appendChild(title);
      header.appendChild(btnQuitar);
      card.appendChild(header);

      const body = document.createElement('div');
      body.className = 'card-body p-2 text-center';

      if (file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.style.height = '120px';
        img.style.objectFit = 'cover';
        img.className = 'img-fluid';
        const reader = new FileReader();
        reader.onload = function(e) {
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
        body.appendChild(img);
      } else if (file.type.startsWith('video/')) {
        const ico = document.createElement('div');
        ico.className = 'mb-2';
        ico.innerHTML = '<i class="bi bi-camera-video fs-1"></i>';
        body.appendChild(ico);
        const small = document.createElement('small');
        small.className = 'd-block text-truncate';
        small.textContent = file.name;
        body.appendChild(small);
      } else {
        const small = document.createElement('small');
        small.className = 'd-block text-truncate';
        small.textContent = file.name;
        body.appendChild(small);
      }

      card.appendChild(body);
      col.appendChild(card);
      listaArchivos.appendChild(col);
    });
  }

  function quitarArchivo(index) {
    if (index < 0 || index >= archivosParaSubir.length) return;
    archivosParaSubir.splice(index, 1);
    renderPreview();
    syncInputFilesWithArray();
  }

  function limpiarArchivos() {
    archivosParaSubir = [];
    const input = document.getElementById('archivos_adicionales_input');
    input.value = '';
    renderPreview();
    syncInputFilesWithArray();
  }


  let formSubmitting = false;
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('#mainForm');
    const galloId = {{ form.instance.pk|default:0 }};

    function showOverlay(withProgress = true) {
      document.getElementById('upload-overlay').style.display = 'block';
      window.addEventListener('beforeunload', beforeUnloadHandler);
      disableFormControls(true);
    }

    function hideOverlay() {
      document.getElementById('upload-overlay').style.display = 'none';
      window.removeEventListener('beforeunload', beforeUnloadHandler);
      disableFormControls(false);
    }

    function beforeUnloadHandler(e) {
      const confirmationMessage = 'Guardando datos, si sale la subida se cancelará.';
      e.returnValue = confirmationMessage;
      return confirmationMessage;
    }

    function disableFormControls(disable) {
      const controls = form.querySelectorAll('input, button, select, textarea');
      controls.forEach(c => c.disabled = disable);
    }

    function updateProgress(percent) {
      document.getElementById('progress-bar').value = percent;
      document.getElementById('progress-text').textContent = `${Math.round(percent)}%`;
    }

    form.onsubmit = async function (e) {
      e.preventDefault();

      if (form.dataset.uploading === '1') {
        console.warn('Ya hay una subida en curso — petición ignorada.');
        return;
      }
      form.dataset.uploading = '1';

      showOverlay(true);

      let allUploadsOk = true;
      let totalBytes = 0;
      let uploadedBytes = 0;

      // Contar total uploads para progreso global
      const nombreImgFile = form.querySelector('input[name="nombre_img"]')?.files[0];
      if (nombreImgFile) totalBytes += nombreImgFile.size;
      archivosParaSubir.forEach(f => totalBytes += f.size);
      

      // Manejar nombre_img
      if (nombreImgFile) {
        try {
          const formDataMeta = new FormData();
          formDataMeta.append('field_name', 'nombre_img');
          formDataMeta.append('folder', 'gll/gallos');
          formDataMeta.append('filename', nombreImgFile.name);
          formDataMeta.append('content_type', nombreImgFile.type);
          formDataMeta.append('file_size', nombreImgFile.size);

          const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;
          const responseMeta = await fetch('/get-presigned-put/', {
            method: 'POST',
            body: formDataMeta,
            headers: { 'X-CSRFToken': csrfToken }
          });

          if (!responseMeta.ok) throw new Error('Failed to get presigned URL');
          const presigned = await responseMeta.json();

          const xhr = new XMLHttpRequest();
          xhr.open('PUT', presigned.url, true);
          xhr.setRequestHeader('Content-Type', nombreImgFile.type);
          xhr.setRequestHeader('x-amz-acl', 'public-read');

          xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
              let percent = ((uploadedBytes + event.loaded) / totalBytes) * 100;
              updateProgress(percent);
            }
          };

          await new Promise((resolve, reject) => {
            xhr.onload = () => {
              if (xhr.status >= 200 && xhr.status < 300) {
                uploadedBytes += nombreImgFile.size;
                resolve();
              } else {
                reject(new Error(`Upload failed: ${xhr.status} - ${xhr.responseText}`));
              }
            };
            xhr.onerror = () => reject(new Error('Network error'));
            xhr.send(nombreImgFile);
          });

          // Agregar hidden con key para nombre_img
          let hidden = form.querySelector('input[name="nombre_img_key"]');
          if (!hidden) {
            hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'nombre_img_key';
            form.appendChild(hidden);
          }
          hidden.value = presigned.key;

          form.querySelector('input[name="nombre_img"]').remove();
        } catch (err) {
          allUploadsOk = false;
          console.error('Error uploading nombre_img:', err);
          Swal.fire({ icon: 'error', title: 'Error', text: `Error subiendo imagen principal: ${err.message}` });
        }
      }

      // Manejar archivos adicionales
      for (let i = 0; i < archivosParaSubir.length; i++) {
        const file = archivosParaSubir[i];
        try {
          const formDataMeta = new FormData();
          formDataMeta.append('action', 'get_presigned');
          formDataMeta.append('field_name', 'archivo');
          formDataMeta.append('folder', 'gll/archivos_adicionales');
          formDataMeta.append('filename', file.name);
          formDataMeta.append('content_type', file.type);
          formDataMeta.append('file_size', file.size);

          const galloId = {{ form.instance.pk|default:"null" }};

          const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;
          const responseMeta = await fetch(`/upload-archivo-adicional/${galloId}/`, {
            method: 'POST',
            body: formDataMeta,
            headers: { 'X-CSRFToken': csrfToken }
          });

          if (!responseMeta.ok) {
            const errorText = await responseMeta.text(); // O .json() si sabes que es JSON
            throw new Error(`Error del servidor: ${responseMeta.status} - ${errorText}`);
          }
          const presigned = await responseMeta.json();

          const xhr = new XMLHttpRequest();
          xhr.open('PUT', presigned.url, true);
          xhr.setRequestHeader('Content-Type', file.type);
          xhr.setRequestHeader('x-amz-acl', 'public-read');

          xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
              let percent = ((uploadedBytes + event.loaded) / totalBytes) * 100;
              updateProgress(percent);
            }
          };

          await new Promise((resolve, reject) => {
            xhr.onload = () => {
              if (xhr.status >= 200 && xhr.status < 300) {
                uploadedBytes += file.size;
                resolve();
              } else {
                reject(new Error(`Upload failed: ${xhr.status} - ${xhr.responseText}`));
              }
            };
            xhr.onerror = () => reject(new Error('Network error'));
            xhr.send(file);
          });

          // Confirmar creación
          const confirmData = new FormData();
          confirmData.append('action', 'confirm');
          confirmData.append('key', presigned.key);
          confirmData.append('tipo', presigned.tipo);
          confirmData.append('nombre', file.name);

          const confirmResponse = await fetch(`/upload-archivo-adicional/${galloId}/`, {
            method: 'POST',
            body: confirmData,
            headers: { 'X-CSRFToken': csrfToken }
          });

          if (!confirmResponse.ok) throw new Error('Failed to confirm upload');
          const confirmResult = await confirmResponse.json();
          console.log(`Archivo adicional creado: ${confirmResult.nombre}`);
        } catch (err) {
          allUploadsOk = false;
          console.error(`Error uploading archivo adicional ${file.name}:`, err);
          Swal.fire({ icon: 'error', title: 'Error', text: `Error subiendo archivo adicional: ${err.message}` });
        }
      }

      archivosParaSubir = [];

      form.dataset.uploading = '0';

      if (allUploadsOk) {
        hideOverlay();
        console.log('Iniciando submit del form a Django...');
        form.submit();
      } else {
        hideOverlay();
      }
    };
  
  });


// Para el modal de los padres
document.addEventListener('DOMContentLoaded', function () {
  // Función para cargar contenido AJAX en el modal de padres
  function cargarPadresModal(url) {
    document.getElementById('padres-modal-loader').classList.remove('d-none');
    document.getElementById('padres-modal-content').classList.add('d-none');
    fetch(url, {
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById('padres-modal-content').innerHTML = data.html;
      attachPadresPaginationListeners(); // Reasignar listeners después de actualizar el contenido
      attachPadreSelectListeners(); // Reasignar listeners a los botones seleccionar
      setupPadresFilter();
    })
    .catch(error => {
      console.error('Error al cargar padres:', error);
    })
    .finally(() => {
      document.getElementById('padres-modal-loader').classList.add('d-none');
      document.getElementById('padres-modal-content').classList.remove('d-none');
    });
  }

  function attachPadresPaginationListeners() {
    document.querySelectorAll('#padres-modal-content .padres-page-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        cargarPadresModal('/ajax/padres/' + this.getAttribute('href'));
      });
    });
  }


  // Igual para madres
  function cargarMadresModal(url) {
    document.getElementById('madres-modal-loader').classList.remove('d-none');
    document.getElementById('madres-modal-content').classList.add('d-none');
    fetch(url, {
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById('madres-modal-content').innerHTML = data.html;
      attachMadresPaginationListeners();
      attachMadreSelectListeners();
      setupMadresFilter();
    })
    .catch(error => {
      console.error('Error al cargar madres:', error);
    })
    .finally(() => {
      document.getElementById('madres-modal-loader').classList.add('d-none');
      document.getElementById('madres-modal-content').classList.remove('d-none');
    });
  }

  function attachMadresPaginationListeners() {
    document.querySelectorAll('#madres-modal-content .madres-page-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        cargarMadresModal('/ajax/madres/' + this.getAttribute('href'));
      });
    });
  }

  // Inicializar listeners cuando se abre el modal
  document.getElementById('modalPadre').addEventListener('show.bs.modal', function () {
    cargarPadresModal('/ajax/padres/?page_padres=1');
  });
  document.getElementById('modalMadre').addEventListener('show.bs.modal', function () {
    cargarMadresModal('/ajax/madres/?page_madres=1');
  });

  function setupPadresFilter() {
    const input = document.getElementById('buscarPlacaPadre');
    const btnNone = document.getElementById('mostrarPlacaNonePadre');
    const noEncontradoDiv = document.getElementById('padre-no-encontrado');
    const buscarEnBD = document.getElementById('buscarPadreEnBD');
    const rows = document.querySelectorAll('#padres-modal-content table tbody tr');

    if (!input) return; // Si el modal aún no se cargó
    input.value = '';

    input.addEventListener('input', function () {
      let found = false;
      rows.forEach(row => {
        const placa = row.querySelector('td:first-child').textContent.toLowerCase();
        const show = placa.includes(input.value.toLowerCase());
        row.style.display = show ? '' : 'none';
        if (show) found = true;
      });
      noEncontradoDiv.classList.toggle('d-none', found || !input.value);
    });

    buscarEnBD.addEventListener('click', function () {
      const valor = input.value;
      document.getElementById('padres-modal-loader').classList.remove('d-none');
      document.getElementById('padres-modal-content').classList.add('d-none');
      fetch(`/ajax/padres/?buscar=${encodeURIComponent(valor)}`, {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('padres-modal-content').innerHTML = data.html;
        attachPadresPaginationListeners();
        attachPadreSelectListeners();
      })
      .catch(error => {
        console.error('Error al buscar padres:', error);
      })
      .finally(() => {
        document.getElementById('padres-modal-loader').classList.add('d-none');
        document.getElementById('padres-modal-content').classList.remove('d-none');
      });
    });
  }

  function setupMadresFilter() {
    const input = document.getElementById('buscarPlacaMadre');
    const btnNone = document.getElementById('mostrarPlacaNoneMadre');
    const noEncontradoDiv = document.getElementById('madre-no-encontrada');
    const buscarEnBD = document.getElementById('buscarMadreEnBD');
    const rows = document.querySelectorAll('#madres-modal-content table tbody tr');

    if (!input) return;

    input.addEventListener('input', function () {
      let found = false;
      rows.forEach(row => {
        const placa = row.querySelector('td:first-child').textContent.toLowerCase();
        const show = placa.includes(input.value.toLowerCase());
        row.style.display = show ? '' : 'none';
        if (show) found = true;
      });
      noEncontradoDiv.classList.toggle('d-none', found || !input.value);
    });

    buscarEnBD.addEventListener('click', function () {
      const valor = input.value;
      document.getElementById('madres-modal-loader').classList.remove('d-none');
      document.getElementById('madres-modal-content').classList.add('d-none');
      fetch(`/ajax/madres/?buscar=${encodeURIComponent(valor)}`, {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('madres-modal-content').innerHTML = data.html;
        attachMadresPaginationListeners();
        attachMadreSelectListeners();
        setupMadresFilter();
      })
      .finally(() => {
        document.getElementById('madres-modal-loader').classList.add('d-none');
        document.getElementById('madres-modal-content').classList.remove('d-none');
      });
    });
  }

  // Si el contenido inicial ya está cargado, asignar listeners
  attachPadresPaginationListeners();
  attachPadreSelectListeners();
  attachMadresPaginationListeners();
  attachMadreSelectListeners();
});

/*
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('encuentroForm');
  function showOverlay() {
    document.getElementById('upload-overlay').style.display = 'block';
    window.addEventListener('beforeunload', beforeUnloadHandler);
    disableFormControls(true);
  }
  function hideOverlay() {
    document.getElementById('upload-overlay').style.display = 'none';
    window.removeEventListener('beforeunload', beforeUnloadHandler);
    disableFormControls(false);
  }
  function beforeUnloadHandler(e) {
    const confirmationMessage = 'Guardando datos, si sale la subida se cancelará.';
    e.returnValue = confirmationMessage;
    return confirmationMessage;
  }
  function disableFormControls(disable) {
    const controls = form.querySelectorAll('input, button, select, textarea');
    controls.forEach(c => c.disabled = disable);
  }
  form.addEventListener('submit', function () {
    showOverlay();
  });
});
*/

</script>
{% endblock %}